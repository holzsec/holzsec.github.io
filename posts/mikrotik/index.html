<!doctype html>
<html data-bs-theme="">
    <head>
                <title>ðŸ›œ Mikrotik Routerboard Home Setup - holzsec</title>

            <meta charset="utf-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">

            
            
            

            
                <link  rel="icon" type="image/x-icon" href="../../assets/img/holzsec.webp">
            
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
                <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/base16/grayscale-dark.min.css">
                <script>hljs.highlightAll();</script>
            <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
            <link rel="stylesheet" href="../../assets/css/bootstrap.min.css">
            <link rel="stylesheet" href="../../assets/css/root.min.css">
            <link rel="stylesheet" href="../../assets/css/main.min.css">
                <script src="../../js/mkdocs-charts-plugin.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
                <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
                <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
                <script src="../../assets/js/vega-render.js"></script>
                <script src="../../search/main.js"></script>

            
                
                    
                    
                    
                     <style>:root {--background: var(--color-white);}</style> 
                
            
    </head>

    <body>
        <div class="container py-3">
            <header>
                    <!-- block header -->
<nav class="navbar navbar-expand-xl border-bottom">
    <div class="container-fluid">
        
            <img class="logo" src="../../assets/img/holzsec.webp">
        

        
            <span class="bold fs-4 title-color site-name" id="component-site-name" style="text-transform: uppercase;">holzsec</span>
        

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsMenu"
            aria-controls="navbarsMenu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse flex-column ml-auto" id="navbarsMenu">
            <ul class="navbar-nav">

                <!-- block menu -->
                <li class="nav-item">
                    <!-- block menu -->
    
        <li class="nav-item" id="component-menu">
            <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="
                            nav-link text-gray text-decoration-none" href="../..">[Home]</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class=" active 
                            nav-link dropdown-toggle text-decoration-none" href="#" data-bs-toggle="dropdown">[Posts]</a>
                            <ul class="dropdown-menu">
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../charts/" class="dropdown-item text-decoration-none ">ðŸ‡¦ðŸ‡¹ Statistics on the Internet</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../emailstandards/" class="dropdown-item text-decoration-none ">ðŸ“§ Email Security Standards</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="./" class="dropdown-item text-decoration-none  active ">ðŸ›œ Mikrotik Routerboard Home Setup</a>
    </li>
<!-- endblock -->
                                    <!-- block dropdown-menu -->
    <li>
        <a href="../storage/" class="dropdown-item text-decoration-none ">Unraid</a>
    </li>
<!-- endblock -->
                            </ul>
                        </li>
            </ul>
        </li>
<!-- endblock -->
                </li>
                <!-- endblock -->

                <!-- block search -->
                <li class="nav-item">
                    <a class="collapsed" data-bs-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
                        <div class="md-search-icon">
                            <i class="fa fa-search" aria-hidden="true"></i>
                        </div>
                    </a>
                </li>
                <!--  endblock -->

                <!-- block source -->
                <li class="nav-item">
                    
                </li>
                <!--  endblock -->
            </ul>
        </div>
    </div>
</nav>
<!--  endblock -->
            </header>

            <main><!-- block search -->
<div class="collapse" id="collapseExample">
    <div role="search" class="search-box">
        <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
            <input type="text" name="q" class="search-query"
            placeholder="Search docs" title="Type search term here" />
        </form>
    </div>
</div>
<!-- endblock -->

                
                        <!-- block content -->
<section class="container post" id="component-content">
    <article>
        <header>
            
            
        </header>
        <p><h1 id="mikrotik-routerboard-home-setup">ðŸ›œ Mikrotik Routerboard Home Setup</h1>
<p>Requires to put your CPE/ADSL modem in bridge mode!
Public IP from provider is routed to the Mikrotik Routerboard.</p>
<p>RouterOS Version and Hardware in Use: RB750Gr3
<a href="https://geizhals.de/mikrotik-routerboard-hex-rb750gr3-a1679274.html">Geizhals</a>
<pre class="highlight"><code class="language-bash">/system/resource/print</code></pre></p>
<pre class="highlight"><code class="language-bash">                  version: 7.6 (stable)
               build-time: Oct/17/2022 10:55:40
         factory-software: 6.46.3
              free-memory: 203.9MiB
             total-memory: 256.0MiB
                      cpu: MIPS 1004Kc V2.15
                cpu-count: 4
            cpu-frequency: 880MHz
                 cpu-load: 0%
           free-hdd-space: 4480.0KiB
          total-hdd-space: 16.0MiB
  write-sect-since-reboot: 10204
         write-sect-total: 13187
               bad-blocks: 0%
        architecture-name: mmips
               board-name: hEX
                 platform: MikroTik
</code></pre>
<h3 id="block-diagram">Block Diagram</h3>
<p><img alt="Block" src="https://i.mt.lv/cdn/product_files/RB750Gr3-esw3_190642.png" /></p>
<h3 id="initial-setup">Initial setup</h3>
<p>1) Reset config 
Power off routerboard, press reset button, power on and hold button until light flashes</p>
<p>2) Router will have DHCP server running on ether1
Connect with cable and get IP.
<pre class="highlight"><code class="language-bash">ssh admin@&lt;routerip&gt; </code></pre>
No password is set by default</p>
<h3 id="choose-options">Choose options</h3>
<p>1) Miktrotik RouterBoard Wifi =&gt; better disable it, ADSL modem is proably better or buy custom access point 
<pre class="highlight"><code class="language-bash">/interface wireless disable wlan</code></pre>
2) Disable Default DHCP-Server on WAN Interface (can also be changed to disable)
<pre class="highlight"><code class="language-bash">/ip dhcp-server remove 0</code></pre>
3) Set Default DHCP Client on WAN interface to not take dns servers from ADSL modem
<pre class="highlight"><code class="language-bash">/ip dhcp-client set 0 interface=ether1 use-peer-dns=yes use-peer-ntp=no add-default-route=yes disabled=no</code></pre>
4) Set custom DNS (to f.e. Quad9 + Allow LAN access)
<pre class="highlight"><code class="language-bash">/ip dns set allow-remote-requests=yes servers=9.9.9.9,149.112.112.112</code></pre>
(Add IPv6 optional: 2620:fe::fe, 2620:fe::9)</p>
<h3 id="create-and-setup-bridge">Create and setup bridge</h3>
<p><pre class="highlight"><code class="language-bash">/interface bridge
add name=bridge1 protocol-mode=none</code></pre>
Interface Lists for better firewalling</p>
<pre class="highlight"><code class="language-bash">/interface list
add name=LANclient
add name=LANserver
add name=LANiot
add name=LAN
add name=WLAN

/interface list member
add interface=ether2 list=LAN
add interface=ether2 list=LANclient
add interface=ether3 list=LAN
add interface=ether3 list=LANclient
add interface=ether4 list=LAN
add interface=ether4 list=LANserver
add interface=ether5 list=LAN
add interface=ether5 list=WLAN

#Default: ether2-5 belong to bridge</code></pre>
<h3 id="dhcp-server">DHCP Server</h3>
<p>Give LAN (DHCP Server) an IP
<pre class="highlight"><code class="language-bash">/ip address add address="&lt;IP addr&gt;/24" interface=bridge</code></pre></p>
<p>Setup DHCP for LAN bridge
<pre class="highlight"><code class="language-bash">/ip pool add name="lan" ranges="&lt;range&gt;"
/ip dhcp-server network add address="&lt;addrpool&gt;/24" gateway="&lt;routeraddr&gt;" netmask="255.255.255.0" dns-server="&lt;routeraddr&gt;" domain="intranet"
/ip dhcp-server add name="lan" interface=bridge lease-time=1h address-pool=lan authoritative=yes bootp-support=none
/ip dhcp-server lease enable 0</code></pre></p>
<p>Internal DNS names
<pre class="highlight"><code class="language-bash">/ip dns static add name="&lt;gw.intranet&gt;" address="&lt;router addr&gt;" ttl=1h</code></pre>
Static DHCP leases with DNS name
<pre class="highlight"><code class="language-bash">/ip dns static add name="&lt;devicename&gt;.intranet" address="&lt;addr&gt;" ttl=1h
/ip dhcp-server lease add address="&lt;addr&gt;" mac-address="&lt;mac&gt;" comment="&lt;devicename&gt;.intranet" server=lan</code></pre></p>
<h3 id="firewalling">Firewalling</h3>
<p>1) Setup WAN port
<pre class="highlight"><code class="language-bash">/ip firewall nat
add action=masquerade chain=srcnat comment="Default masq" out-interface=ether1</code></pre></p>
<p>2) Setup WAN firewall
<pre class="highlight"><code class="language-bash">/ip firewall filter
add action=accept chain=input comment="Accept established related" connection-state=established,related
add action=accept chain=input comment="Allow LAN access to router and Internet" in-interface-list=LAN
#Optional: add action=accept chain=input comment="Allow ping ICMP from anywhere" protocol=icmp
add action=drop chain=input comment="Drop all other input"
add action=accept chain=forward comment="Accept established related" connection-state=established,related
add action=accept chain=forward comment="Allow LAN access to router and Internet" connection-state=new in-interface-list=LAN
add action=accept chain=forward comment="Accept Port forwards" connection-nat-state=dstnat in-interface=ether1
add action=drop chain=forward comment="Drop all other forward"</code></pre></p>
<p>3) Optional: Filter outbound connections from internal devices (f.e. IoT devices)
<pre class="highlight"><code class="language-bash">/ip firewall filter add action=drop chain=output comment="Block outgoing traffic from IoT-device" src-address=&lt;device-ip&gt;</code></pre></p>
<h3 id="port-forwarding">Port Forwarding</h3>
<p>VPN (Wireguard)
<pre class="highlight"><code class="language-bash">/ip firewall nat add chain=dstnat in-interface=ether1 dst-port=51820 action=dst-nat protocol=udp to-address=&lt;vpn-ip&gt; to-port=51820</code></pre>
Nginx Reverse Proxy
<pre class="highlight"><code class="language-bash">/ip firewall nat add chain=dstnat in-interface=ether1 dst-port=443 action=dst-nat protocol=tcp to-address=&lt;serveraddr&gt; to-port=443
/ip firewall nat add chain=dstnat in-interface=ether1 dst-port=80 action=dst-nat protocol=tcp to-address=&lt;serveraddr&gt; to-port=80</code></pre></p>
<h3 id="security">Security</h3>
<p>Turn off unneeded helpers
<pre class="highlight"><code class="language-bash">/ip firewall service-port
set ftp disabled=yes
set tftp disabled=yes
set irc disabled=yes
set h323 disabled=yes
set sip disabled=yes
set pptp disabled=yes
set udplite disabled=yes
set dccp disabled=yes
set sctp disabled=yes</code></pre></p>
<p>Turn off unneeded services || VERIFY if above steps worked, otherwise it might get complicated to connect to SSH service from wrong IP range</p>
<blockquote>
<p><b>This also disables the GUI (avoid disabling winbox, www) if needed!</b></p>
</blockquote>
<pre class="highlight"><code class="language-bash">/ip service
set telnet disabled=yes
set ftp disabled=yes
set api disabled=yes
set ssh address=192.168.1.0/24
set winbox disabled=yes
set api-ssl disabled=yes
set www disabled=yes
set www-ssl disabled=yes</code></pre>
<p>Misc IP settings
<pre class="highlight"><code class="language-bash">/ip ssh
set strong-crypto=yes
/ip settings
set rp-filter=no secure-redirects=yes send-redirects=yes tcp-syncookies=no</code></pre></p>
<p>Remove/disable default ip at last
<pre class="highlight"><code class="language-bash">/ip address remove 0</code></pre></p>
<p>SSH Access with ssh-keys
<pre class="highlight"><code class="language-bash">ssh-keygen -t rsa -b 4096 -m 'PEM'
#Mikrotik only  accepts PEM formatted keys (you can convert your key like this:)
ssh-keygen -f ~/.ssh/id_rsa.pub -e -m 'PEM' &gt;&gt; ~/.ssh/id_rsa.pub.pem</code></pre></p>
<p>Copy the pubkey to persistent storage on the routerboard (flash/id_rsa.pub.pem)</p>
<p>On the router:
<pre class="highlight"><code class="language-bash">user ssh-keys import public-key-file="flash/id_rsa.pub.pem" user=&lt;username&gt;</code></pre></p>
<h3 id="graphs">Graphs</h3>
<p>Per default resource graph for CPU, Memory and Disk usage is collected every 5 minutes. 
The graph can be accessed under: http://<i>RouterIP</i>/graphs
<pre class="highlight"><code class="language-bash">/ip service set www disabled=no
/tool graphing resource add allow-address "192.168.1.0/24"
/tool graphing resource add disabled=no</code></pre></p>
<p><b>Custom data retrieval</b></p>
<p>bash script.sh <i>username</i> <i>router IP</i>  <br></p>
<p>Description: Creates a single ssh connection to the router (ssh-keys recommended first), runs multiple commands every 0.5 seconds, outputs it to stdout <br>
Optional: redirect output to log file <code>&gt;&gt; router-stats.log</code></p>
<pre class="highlight"><code class="language-bash">#
# Persistent SSH Connection accross multiple commands
#
user=$1
target=$2

host="$user@$target"

tmp_dir=$(mktemp -d "/tmp/$(basename "$0").XXXXXX")
ssh_control_socket="$tmp_dir/ssh_control_socket"

# Setup control master
echo $(date)": Initiating SSH Master socket to $host"
ssh -f -N -o 'ControlMaster=yes' -S $ssh_control_socket $host 
remote_cmd="ssh -o LogLevel=QUIET -S $ssh_control_socket $host"

while true; do 
    #Retrieve Number of IPv6 Neighbor discovery cache entries
    entries=$($remote_cmd /ipv6 neighbor/ print)
    echo "$entries" | cut -d " " -f1 | grep -v -e '^[[:space:]]*$' | tail -n 1

    #Retrieve CPU Usage
    cpu=$($remote_cmd :put [/system resource get "cpu-load"])
    #$($remote_cmd /system resource cpu print)
    echo "$cpu"

    #Retrieve free RAM
    ram=$($remote_cmd :put [/system resource get "free-memory"])
    echo "$ram"

    #Retrieve free HDD Space
    hdd=$($remote_cmd :put [/system resource get "free-hdd-space"])
    echo "$hdd"

    echo "---"

    sleep 0.5
done
#Close Connection
echo $(date)": Exiting SSH Master socket to $host"
ssh -S "$ssh_control_socket" -O check $host
ssh -S "$ssh_control_socket" -O exit $host</code></pre></p>
    </article>
</section>
<!-- endblock -->
                
                
            </main>

            
                    <!-- block preview -->
    <div class="preview row row-cols-md-3 text-center pt-md-3" id="component-preview">
        <div class="col themed-grid-col">
            <a rel="prev" href="../emailstandards/" class="nav-link">
                <i class="fa fa-arrow-left"></i> Previous
            </a>
        </div>
        <div class="col themed-grid-col"></div>
        <div class="col themed-grid-col">
            <a rel="next" href="../storage/" class="nav-link">
                Next <i class="fa fa-arrow-right"></i>
            </a>
        </div>
    </div>
<!-- endblock -->
            

            
            
        </div>

            <script>var base_url = '../..';</script>
            <script src="../../assets/js/jquery-3.3.1.slim.min.js""></script>
            <script src="../../assets/js/bootstrap.bundle.min.js""></script>
            <script src="../../assets/js/main.min.js""></script>
                <script src="../../js/mkdocs-charts-plugin.js" defer></script>
                <script src="https://cdn.jsdelivr.net/npm/vega@5" defer></script>
                <script src="https://cdn.jsdelivr.net/npm/vega-lite@5" defer></script>
                <script src="https://cdn.jsdelivr.net/npm/vega-embed@6" defer></script>
                <script src="../../assets/js/vega-render.js" defer></script>
                <script src="../../search/main.js" defer></script>

    </body>

</html>